---
import { ClientRouter } from 'astro:transitions';
import SidebarLayout from '../components/common/SidebarLayout';
import '../styles/global.css';
const title = Astro.props.title ?? 'ระบบใบสั่งซื้อ';

const themeCookie = Astro.cookies.get('theme')?.value || 'light';
let serverTheme = themeCookie;

if (serverTheme === 'system') {
  serverTheme = 'light';
}

const initialDarkClass = serverTheme === 'dark';
---

<html lang="th" class:list={[initialDarkClass && 'dark']}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    
    <script is:inline>
      (function() {
        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(';').shift();
          return null;
        }

        function setCookie(name, value) {
          document.cookie = `${name}=${value}; path=/; max-age=31536000; SameSite=Lax`;
        }

        const localTheme = localStorage.getItem('theme');
        const cookieTheme = getCookie('theme');
        
        let finalTheme = localTheme || cookieTheme || 'light';
        
        let isDark = false;
        if (finalTheme === 'dark') {
          isDark = true;
        } else if (finalTheme === 'system') {
          isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        }
        
        document.documentElement.classList[isDark ? 'add' : 'remove']('dark');
        
        if (!localTheme) {
          localStorage.setItem('theme', finalTheme);
        }
        if (localTheme && localTheme !== cookieTheme) {
          setCookie('theme', localTheme);
        }
      })();
    </script>
    
    <ClientRouter />
  </head>

  <body>
    <SidebarLayout client:visible>
      <slot />
    </SidebarLayout>
  </body>
</html>