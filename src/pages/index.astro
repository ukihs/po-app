---
import '../styles/global.css';
import { verifyFirebaseToken, extractIdTokenFromCookie } from '../lib/firebase-auth';

const cookieHeader = Astro.request.headers.get('Cookie');
const idToken = extractIdTokenFromCookie(cookieHeader);
let redirectUrl = '/login';

if (idToken) {
  try {
    const user = await verifyFirebaseToken(idToken);
    if (user) {
      if (user.role === 'buyer') {
        redirectUrl = '/orders/create';
      } else if (user.role === 'supervisor') {
        redirectUrl = '/orders/tracking';
      } else if (user.role === 'procurement') {
        redirectUrl = '/orders/list';
      } else if (user.role === 'superadmin') {
        redirectUrl = '/admin/users';
      }
    }
  } catch (error) {
    console.error('Token verification failed:', error);
    redirectUrl = '/login';
  }
}

return Astro.redirect(redirectUrl);
---
