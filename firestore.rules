rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isAuth() { 
      return request.auth != null; 
    }

    function getUserRole() {
      return isAuth() 
        ? request.auth.token.role
        : null;
    }

    function isAdmin() { 
      return getUserRole() == 'admin'; 
    }


    function onlyChanges(allowedFields) {
      return request.resource.data.diff(resource.data).changedKeys().hasOnly(allowedFields);
    }

    match /users/{userId} {
      allow read: if isAuth();
      allow create: if isAdmin();
      allow update: if isAdmin() || 
                       (isAuth() && 
                        request.auth.uid == userId && 
                        onlyChanges(['displayName', 'email', 'firstName', 'lastName', 'photoURL']));
      allow delete: if isAdmin();
    }

    match /orders/{orderId} {
      allow read: if isAuth();
      allow create: if isAuth() && getUserRole() in ['employee', 'supervisor', 'procurement'];
      allow update: if isAuth() && 
                       (isAdmin() ||
                        (request.auth.uid == resource.data.requesterUid && resource.data.status == 'pending') ||
                        (getUserRole() == 'supervisor' && resource.data.status != 'rejected') ||
                        (getUserRole() == 'procurement' && resource.data.status != 'pending' && resource.data.status != 'rejected'));
      allow delete: if isAdmin();
    }

    match /notifications/{notificationId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update: if isAuth();
      allow delete: if isAdmin();
    }

    match /counters/{counterId} {
      allow read: if isAuth();
      allow write: if isAuth();
    }

    match /categories/{categoryId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /suppliers/{supplierId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /departments/{departmentId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /itemCategories/{itemCategoryId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /itemStatuses/{itemStatusId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /procurementData/{procurementId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /logs/{logId} {
      allow read: if isAdmin();
      allow write: if isAuth();
    }

    match /settings/{settingId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /reports/{reportId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /templates/{templateId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /attachments/{attachmentId} {
      allow read: if isAuth();
      allow write: if isAuth();
    }

    match /debug/{debugId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /system/{systemId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /backup/{backupId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /audit/{auditId} {
      allow read: if isAdmin();
      allow write: if isAuth();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}